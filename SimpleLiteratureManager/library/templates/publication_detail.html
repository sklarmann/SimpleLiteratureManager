{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1 class="mb-0">{{ publication.title }}</h1>
        <p class="mb-0 text-muted">Publikationsdetails</p>
    </div>
    <a class="btn btn-primary" href="{% url 'publication_update' publication.id %}">Bearbeiten</a>
</div>

<div class="card mb-4">
    <div class="card-body">
        <dl class="row mb-0">
            <dt class="col-sm-3">Jahr</dt>
            <dd class="col-sm-9">{{ publication.year }}</dd>

            <dt class="col-sm-3">Typ</dt>
            <dd class="col-sm-9">{{ publication.get_publication_type_display }}</dd>

            <dt class="col-sm-3">Journal</dt>
            <dd class="col-sm-9">
                {% if publication.journal %}
                    <a href="{% url 'journal_detail' publication.journal.id %}">{{ publication.journal.name }}</a>
                {% else %}
                    -
                {% endif %}
            </dd>

            <dt class="col-sm-3">Volume</dt>
            <dd class="col-sm-9">{{ publication.volume|default_if_none:"-" }}</dd>

            <dt class="col-sm-3">Seiten</dt>
            <dd class="col-sm-9">{{ publication.pages|default_if_none:"-" }}</dd>

            <dt class="col-sm-3">Autoren</dt>
            <dd class="col-sm-9">
                {% if publication.ordered_authors %}
                    {% for author in publication.ordered_authors %}
                        <a href="{% url 'author_detail' author.id %}">{{ author }}</a>{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                {% else %}
                    -
                {% endif %}
            </dd>

            <dt class="col-sm-3">Tags</dt>
            <dd class="col-sm-9">
                {% if publication.tags.all|length %}
                    {% for tag in publication.tags.all %}
                        <span class="badge bg-secondary me-1">{{ tag.name }}</span>
                    {% endfor %}
                {% else %}
                    -
                {% endif %}
            </dd>

            <dt class="col-sm-3">Projekte</dt>
            <dd class="col-sm-9">
                {% if publication.projects.all|length %}
                    {% for project in publication.projects.all %}
                        <a href="{% url 'project_detail' project.id %}" class="me-2">{{ project.title }}</a>
                    {% endfor %}
                {% else %}
                    -
                {% endif %}
            </dd>

            <dt class="col-sm-3">DOI</dt>
            <dd class="col-sm-9">
                {% if publication.doi %}
                    <a href="https://doi.org/{{ publication.doi }}" target="_blank" rel="noopener">{{ publication.doi }}</a>
                {% else %}
                    -
                {% endif %}
            </dd>

            <dt class="col-sm-3">BibTeX-ID</dt>
            <dd class="col-sm-9">{{ publication.bibtex_key }}</dd>

            <dt class="col-sm-3">Abstract</dt>
            <dd class="col-sm-9">{{ publication.abstract|default_if_none:"-" }}</dd>
        </dl>

        {% if publication.pdf %}
            <a href="{{ publication.pdf.url }}" class="btn btn-outline-primary mt-3" target="_blank" rel="noopener">PDF öffnen</a>
        {% endif %}
    </div>
</div>

<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <span>BibLaTeX</span>
        <div class="d-flex align-items-center gap-2">
            <button
                class="btn btn-outline-secondary btn-sm"
                id="toggle-journal-names"
                type="button"
                aria-pressed="false"
            >Journal-Kurznamen nutzen</button>
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" role="switch" id="toggle-short-names">
                <label class="form-check-label" for="toggle-short-names">Vornamen abkürzen</label>
            </div>
            <button class="btn btn-outline-secondary btn-sm" id="copy-biblatex">In Zwischenablage kopieren</button>
        </div>
    </div>
    <div class="card-body">
        <label class="form-label fw-semibold" for="biblatex-entry">Eintrag</label>
        <textarea
            id="biblatex-entry"
            class="form-control font-monospace"
            rows="8"
            readonly
            data-author-long-journal-long="{{ publication.biblatex_entry }}"
            data-author-short-journal-long="{{ publication.biblatex_entry_short }}"
            data-author-long-journal-short="{{ publication.biblatex_entry_short_journal }}"
            data-author-short-journal-short="{{ publication.biblatex_entry_short_all }}"
        >{{ publication.biblatex_entry }}</textarea>
        <div id="copy-feedback" class="text-success small mt-2 d-none">Eintrag wurde kopiert.</div>
    </div>
</div>

{% if publication.pdf %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css" integrity="sha512-1fs/Hggsu2HrksBmbteKrYnb70SP3yjHfxcfTl1Pq1w3+sxCH/xUCFMJL8NfgKkLDGLcZ3uimJ5UJxdXXZSpzg==" crossorigin="anonymous" referrerpolicy="no-referrer">
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>PDF</span>
        <small class="text-muted">Markieren Sie Text im PDF, um eine Notiz zu speichern.</small>
    </div>
    <div class="card-body">
        <div class="position-relative" style="height: 800px;">
            <div id="pdf-viewer-container" class="border rounded p-2 viewerContainer position-absolute top-0 bottom-0 start-0 end-0 overflow-auto">
                <div id="pdf-viewer" class="pdfViewer"></div>
                <div id="pdf-error" class="alert alert-warning mt-3 d-none" role="alert">
                    Das PDF konnte nicht geladen werden.
                </div>
            </div>
        </div>
        <div class="mt-3 p-3 bg-light rounded" id="annotation-panel" data-annotations-url="{% url 'publication_annotations' publication.id %}">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <div class="d-flex align-items-center gap-2">
                    <label class="form-label mb-0" for="annotation-color">Farbe</label>
                    <input type="color" class="form-control form-control-color" id="annotation-color" value="#ffeb3b" title="Markierungsfarbe">
                </div>
                <div class="flex-grow-1">
                    <label for="annotation-comment" class="form-label mb-1">Kommentar</label>
                    <textarea id="annotation-comment" class="form-control" rows="2" placeholder="Kommentar zur Markierung"></textarea>
                </div>
                <div class="d-flex flex-column align-items-end" style="min-width: 200px;">
                    <button class="btn btn-primary mb-1" id="save-annotation" disabled>Markierung speichern</button>
                    <small class="text-muted" id="annotation-hint">Text im PDF markieren, um eine neue Markierung anzulegen.</small>
                </div>
            </div>
            <hr>
            <div>
                <h5 class="h6">Gespeicherte Markierungen</h5>
                <div id="annotation-list" class="list-group list-group-flush"></div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<a class="btn btn-secondary" href="{% url 'publication_list' %}">Zurück zur Liste</a>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const copyButton = document.getElementById("copy-biblatex");
        const textarea = document.getElementById("biblatex-entry");
        const feedback = document.getElementById("copy-feedback");
        const toggleShortNames = document.getElementById("toggle-short-names");
        const toggleJournalNames = document.getElementById("toggle-journal-names");
        let useShortJournalNames = false;

        if (!copyButton || !textarea) {
            return;
        }

        const showFeedback = (message, isError = false) => {
            if (!feedback) {
                return;
            }
            feedback.textContent = message;
            feedback.classList.toggle("text-success", !isError);
            feedback.classList.toggle("text-danger", isError);
            feedback.classList.remove("d-none");

            setTimeout(() => feedback.classList.add("d-none"), 2000);
        };

        const updateEntry = () => {
            if (!textarea) {
                return;
            }
            const useShortAuthors = toggleShortNames?.checked ?? false;
            const datasetKey = (() => {
                if (useShortAuthors && useShortJournalNames) {
                    return "authorShortJournalShort";
                }
                if (useShortAuthors) {
                    return "authorShortJournalLong";
                }
                if (useShortJournalNames) {
                    return "authorLongJournalShort";
                }
                return "authorLongJournalLong";
            })();
            const targetValue = textarea.dataset[datasetKey];
            textarea.value = targetValue || "";
        };

        if (toggleShortNames) {
            toggleShortNames.addEventListener("change", updateEntry);
        }

        const updateJournalButton = () => {
            if (!toggleJournalNames) {
                return;
            }
            toggleJournalNames.textContent = useShortJournalNames
                ? "Journal-Namen anzeigen"
                : "Journal-Kurznamen nutzen";
            toggleJournalNames.setAttribute("aria-pressed", useShortJournalNames.toString());
        };

        if (toggleJournalNames) {
            toggleJournalNames.addEventListener("click", () => {
                useShortJournalNames = !useShortJournalNames;
                updateJournalButton();
                updateEntry();
            });
            updateJournalButton();
        }

        copyButton.addEventListener("click", async () => {
            try {
                await navigator.clipboard.writeText(textarea.value);
                showFeedback("Eintrag wurde kopiert.");
            } catch (error) {
                showFeedback("Kopieren nicht möglich.", true);
            }
        });

        updateEntry();
    });
</script>

{% if publication.pdf %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" integrity="sha512-q+4liFwdPC/bNdhUpZx6aXDx/h77yEQtn4I1slHydcbZK34nLaR3cAeYSJshoxIOq3mjEf7xJE8YWIUHMn+oCQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.js" integrity="sha512-r/1hgDCXmxicFJ66QCjMCFl0dEhTBu7kYqoef3OrdHbqrnyhp1V/GhyWQg8Gto8412MUqU8AbMSpc5TLbRURhQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="{% static 'library/js/publication_pdf_viewer.js' %}"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            initPublicationPdfViewer({
                pdfUrl: "{{ publication.pdf.url }}",
                workerSrc: "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js",
                annotationsUrl: "{% url 'publication_annotations' publication.id %}",
                annotationDetailUrlTemplate: "{% url 'publication_annotation_detail' publication.id 0 %}",
            });
        });
    </script>
{% endif %}
{% endblock %}
