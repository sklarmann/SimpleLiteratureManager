{% extends "base.html" %}
{% block content %}

<h1>{% if is_edit %}Publikation bearbeiten{% else %}Publikation hinzufügen{% endif %}</h1>

<form method="POST" enctype="multipart/form-data" class="mt-3">
    {% csrf_token %}

    <div class="mb-3">
        {{ form.title.label_tag }}
        {{ form.title }}
        {% for error in form.title.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        {{ form.year.label_tag }}
        {{ form.year }}
        {% for error in form.year.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        {{ form.doi.label_tag }}
        {{ form.doi }}
        {% for error in form.doi.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        {{ form.authors.label_tag }}
        <div class="row g-2 align-items-start">
            <div class="col-md-5">
                <label for="available-authors" class="form-label">Alle Autoren</label>
                <input
                    type="text"
                    id="author-filter"
                    class="form-control mb-2"
                    placeholder="Autoren filtern"
                />
                <select multiple class="form-select" size="10" id="available-authors"></select>
            </div>
            <div class="col-md-2 d-flex flex-column align-items-center justify-content-center gap-2">
                <button type="button" class="btn btn-outline-primary w-100" id="add-author">
                    Hinzufügen &raquo;
                </button>
                <button type="button" class="btn btn-outline-secondary w-100" id="remove-author">
                    &laquo; Entfernen
                </button>
            </div>
            <div class="col-md-5">
                <label for="selected-authors" class="form-label">Zugeordnete Autoren</label>
                <select multiple class="form-select" size="12" id="selected-authors"></select>
            </div>
        </div>
        <div class="d-none">
            {{ form.authors }}
        </div>
        {% for error in form.authors.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        {{ form.journal.label_tag }}
        {{ form.journal }}
        {% for error in form.journal.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        {{ form.tags.label_tag }}
        {{ form.tags }}
        {% for error in form.tags.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        {{ form.abstract.label_tag }}
        {{ form.abstract }}
        {% for error in form.abstract.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        {{ form.pdf.label_tag }}
        {{ form.pdf }}
        {% for error in form.pdf.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <button class="btn btn-primary" type="submit">{% if is_edit %}Aktualisieren{% else %}Speichern{% endif %}</button>
    {% if is_edit %}
        <a class="btn btn-secondary" href="{% url 'publication_detail' publication.id %}">Abbrechen</a>
    {% else %}
        <a class="btn btn-secondary" href="{% url 'publication_list' %}">Abbrechen</a>
    {% endif %}
</form>

<script>
    (function () {
        const hiddenSelect = document.getElementById("id_authors");
        const availableSelect = document.getElementById("available-authors");
        const selectedSelect = document.getElementById("selected-authors");
        const filterInput = document.getElementById("author-filter");
        const addButton = document.getElementById("add-author");
        const removeButton = document.getElementById("remove-author");

        if (!hiddenSelect) {
            return;
        }

        const allOptions = Array.from(hiddenSelect.options).map((option) => option.cloneNode(true));

        const renderLists = () => {
            availableSelect.innerHTML = "";
            selectedSelect.innerHTML = "";

            const filterValue = filterInput.value.toLowerCase();

            allOptions.forEach((option) => {
                const targetSelect = option.selected ? selectedSelect : availableSelect;
                const matchesFilter = option.text.toLowerCase().includes(filterValue);

                if (!option.selected && filterValue && !matchesFilter) {
                    return;
                }

                targetSelect.appendChild(option.cloneNode(true));
            });
        };

        const moveOptions = (fromSelect, toSelect, markSelected) => {
            const selectedOptions = Array.from(fromSelect.selectedOptions);
            if (!selectedOptions.length) {
                return;
            }

            selectedOptions.forEach((option) => {
                const original = allOptions.find((opt) => opt.value === option.value);
                if (original) {
                    original.selected = markSelected;
                }
            });
            renderLists();
        };

        addButton?.addEventListener("click", () => moveOptions(availableSelect, selectedSelect, true));
        removeButton?.addEventListener("click", () => moveOptions(selectedSelect, availableSelect, false));
        filterInput?.addEventListener("input", renderLists);

        document.querySelector("form")?.addEventListener("submit", () => {
            Array.from(hiddenSelect.options).forEach((option) => {
                option.selected = allOptions.some((opt) => opt.value === option.value && opt.selected);
            });
        });

        renderLists();
    })();
</script>

{% endblock %}
