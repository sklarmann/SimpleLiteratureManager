{% extends "base.html" %}
{% block content %}

<h1>{% if is_edit %}Publikation bearbeiten{% else %}Publikation hinzuf端gen{% endif %}</h1>

<form method="POST" enctype="multipart/form-data" class="mt-3">
    {% csrf_token %}

    <div class="mb-3">
        {{ form.title.label_tag }}
        {{ form.title }}
        {% for error in form.title.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        {{ form.year.label_tag }}
        {{ form.year }}
        {% for error in form.year.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        {{ form.doi.label_tag }}
        {{ form.doi }}
        {% for error in form.doi.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
        {% if is_edit %}
            <div class="mt-2">
                <a class="btn btn-outline-info btn-sm" href="{% url 'publication_update_from_doi' publication.id %}">
                    Daten via DOI abrufen
                </a>
            </div>
        {% endif %}
    </div>

    <div class="mb-3">
        {{ form.publication_type.label_tag }}
        {{ form.publication_type }}
        {% for error in form.publication_type.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        {{ form.authors.label_tag }}
        <div class="row g-2 align-items-start">
            <div class="col-md-5">
                <label for="available-authors" class="form-label">Alle Autoren</label>
                <input
                    type="text"
                    id="author-filter"
                    class="form-control mb-2"
                    placeholder="Autoren filtern"
                />
                <select multiple class="form-select" size="10" id="available-authors"></select>
            </div>
            <div class="col-md-2 d-flex flex-column align-items-center justify-content-center gap-2">
                <button type="button" class="btn btn-outline-primary w-100" id="add-author">
                    Hinzuf端gen &raquo;
                </button>
                <button type="button" class="btn btn-outline-secondary w-100" id="remove-author">
                    &laquo; Entfernen
                </button>
            </div>
            <div class="col-md-5">
                <label for="selected-authors" class="form-label">Zugeordnete Autoren</label>
                <select multiple class="form-select" size="12" id="selected-authors"></select>
                <div class="d-flex gap-2 mt-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="move-author-up">
                        Nach oben
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="move-author-down">
                        Nach unten
                    </button>
                </div>
            </div>
        </div>
        <div class="d-none">
            {{ form.authors }}
            {{ form.authors_order }}
        </div>
        {% for error in form.authors.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        {{ form.journal.label_tag }}
        {{ form.journal }}
        {% for error in form.journal.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="row g-3">
        <div class="col-md-6">
            <div class="mb-3">
                {{ form.volume.label_tag }}
                {{ form.volume }}
                {% for error in form.volume.errors %}
                    <div class="text-danger small">{{ error }}</div>
                {% endfor %}
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                {{ form.pages.label_tag }}
                {{ form.pages }}
                {% for error in form.pages.errors %}
                    <div class="text-danger small">{{ error }}</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="mb-3">
        {{ form.tags.label_tag }}
        <div class="row g-2 align-items-start">
            <div class="col-md-5">
                <label for="available-tags" class="form-label">Alle Tags</label>
                <input
                    type="text"
                    id="tag-filter"
                    class="form-control mb-2"
                    placeholder="Tags filtern"
                />
                <select multiple class="form-select" size="10" id="available-tags"></select>
            </div>
            <div class="col-md-2 d-flex flex-column align-items-center justify-content-center gap-2">
                <button type="button" class="btn btn-outline-primary w-100" id="add-tag">
                    Hinzuf端gen &raquo;
                </button>
                <button type="button" class="btn btn-outline-secondary w-100" id="remove-tag">
                    &laquo; Entfernen
                </button>
            </div>
            <div class="col-md-5">
                <label for="selected-tags" class="form-label">Zugeordnete Tags</label>
                <select multiple class="form-select" size="12" id="selected-tags"></select>
            </div>
        </div>
        <div class="d-none">
            {{ form.tags }}
        </div>
        {% for error in form.tags.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        {{ form.projects.label_tag }}
        <div class="row g-2 align-items-start">
            <div class="col-md-5">
                <label for="available-projects" class="form-label">Alle Projekte</label>
                <input
                    type="text"
                    id="project-filter"
                    class="form-control mb-2"
                    placeholder="Projekte filtern"
                />
                <select multiple class="form-select" size="10" id="available-projects"></select>
            </div>
            <div class="col-md-2 d-flex flex-column align-items-center justify-content-center gap-2">
                <button type="button" class="btn btn-outline-primary w-100" id="add-project">
                    Hinzuf端gen &raquo;
                </button>
                <button type="button" class="btn btn-outline-secondary w-100" id="remove-project">
                    &laquo; Entfernen
                </button>
            </div>
            <div class="col-md-5">
                <label for="selected-projects" class="form-label">Zugeordnete Projekte</label>
                <select multiple class="form-select" size="12" id="selected-projects"></select>
            </div>
        </div>
        <div class="d-none">
            {{ form.projects }}
        </div>
        {% for error in form.projects.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        {{ form.abstract.label_tag }}
        {{ form.abstract }}
        {% for error in form.abstract.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        {{ form.pdf.label_tag }}
        {{ form.pdf }}
        {% for error in form.pdf.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <button class="btn btn-primary" type="submit">{% if is_edit %}Aktualisieren{% else %}Speichern{% endif %}</button>
    {% if is_edit %}
        <a class="btn btn-secondary" href="{% url 'publication_detail' publication.id %}">Abbrechen</a>
    {% else %}
        <a class="btn btn-secondary" href="{% url 'publication_list' %}">Abbrechen</a>
    {% endif %}
</form>

<script>
    (function () {
        const setupDualList = ({
            hiddenSelectId,
            availableSelectId,
            selectedSelectId,
            filterInputId,
            addButtonId,
            removeButtonId,
            moveUpButtonId,
            moveDownButtonId,
        }) => {
            const hiddenSelect = document.getElementById(hiddenSelectId);
            const availableSelect = document.getElementById(availableSelectId);
            const selectedSelect = document.getElementById(selectedSelectId);
            const filterInput = document.getElementById(filterInputId);
            const addButton = document.getElementById(addButtonId);
            const removeButton = document.getElementById(removeButtonId);
            const moveUpButton = document.getElementById(moveUpButtonId);
            const moveDownButton = document.getElementById(moveDownButtonId);
            const orderInput = document.getElementById("id_authors_order");

            if (!hiddenSelect || !availableSelect || !selectedSelect) {
                return;
            }

            const allOptions = Array.from(hiddenSelect.options).map((option) => option.cloneNode(true));
            let selectedOrder = [];

            const setInitialOrder = () => {
                const raw = orderInput?.value || "";
                selectedOrder = raw
                    .split(",")
                    .map((value) => value.trim())
                    .filter(Boolean);

                if (!selectedOrder.length) {
                    selectedOrder = Array.from(hiddenSelect.options)
                        .filter((option) => option.selected)
                        .map((option) => option.value);
                }
            };

            setInitialOrder();

            const renderLists = () => {
                availableSelect.innerHTML = "";
                selectedSelect.innerHTML = "";

                const filterValue = filterInput?.value.toLowerCase() || "";
                const selectedSet = new Set(selectedOrder);

                const availableOptions = allOptions.filter(
                    (option) => !selectedSet.has(option.value)
                );
                availableOptions
                    .filter(
                        (option) =>
                            !filterValue || option.text.toLowerCase().includes(filterValue),
                    )
                    .sort((a, b) => a.text.localeCompare(b.text))
                    .forEach((option) => availableSelect.appendChild(option.cloneNode(true)));

                selectedOrder
                    .map((value) => allOptions.find((option) => option.value === value))
                    .filter(Boolean)
                    .forEach((option) => {
                        const clone = option.cloneNode(true);
                        clone.selected = true;
                        selectedSelect.appendChild(clone);
                    });
            };

            const syncHiddenFields = () => {
                if (orderInput) {
                    orderInput.value = selectedOrder.join(",");
                }

                const selectedSet = new Set(selectedOrder);
                Array.from(hiddenSelect.options).forEach((option) => {
                    option.selected = selectedSet.has(option.value);
                });
            };

            const moveOptions = (fromSelect, markSelected) => {
                const selectedOptions = Array.from(fromSelect.selectedOptions);
                if (!selectedOptions.length) {
                    return;
                }

                selectedOptions.forEach((option) => {
                    const original = allOptions.find((opt) => opt.value === option.value);
                    if (original) {
                        const value = original.value;
                        original.selected = markSelected;
                        if (markSelected) {
                            if (!selectedOrder.includes(value)) {
                                selectedOrder.push(value);
                            }
                        } else {
                            selectedOrder = selectedOrder.filter((id) => id !== value);
                        }
                    }
                });
                renderLists();
                syncHiddenFields();
            };

            addButton?.addEventListener("click", () => moveOptions(availableSelect, true));
            removeButton?.addEventListener("click", () => moveOptions(selectedSelect, false));
            filterInput?.addEventListener("input", renderLists);

            const reorderSelection = (direction) => {
                const selectedIds = new Set(
                    Array.from(selectedSelect.selectedOptions).map((option) => option.value),
                );
                if (!selectedIds.size) {
                    return;
                }

                const indices = selectedOrder
                    .map((value, index) => ({ value, index }))
                    .filter(({ value }) => selectedIds.has(value))
                    .map(({ index }) => index);

                if (!indices.length) {
                    return;
                }

                const step = direction === "up" ? -1 : 1;
                const reordered = [...selectedOrder];
                const sortedIndices =
                    direction === "up"
                        ? indices.sort((a, b) => a - b)
                        : indices.sort((a, b) => b - a);

                sortedIndices.forEach((currentIndex) => {
                    const newIndex = currentIndex + step;
                    if (newIndex < 0 || newIndex >= reordered.length) {
                        return;
                    }
                    const temp = reordered[newIndex];
                    reordered[newIndex] = reordered[currentIndex];
                    reordered[currentIndex] = temp;
                });

                selectedOrder = reordered;
                renderLists();
                syncHiddenFields();

                selectedSelect.selectedIndex = -1;
                Array.from(selectedSelect.options).forEach((option) => {
                    if (selectedIds.has(option.value)) {
                        option.selected = true;
                    }
                });
            };

            moveUpButton?.addEventListener("click", () => reorderSelection("up"));
            moveDownButton?.addEventListener("click", () => reorderSelection("down"));

            document.querySelector("form")?.addEventListener("submit", () => {
                syncHiddenFields();
            });

            renderLists();
            syncHiddenFields();
        };

        setupDualList({
            hiddenSelectId: "id_authors",
            availableSelectId: "available-authors",
            selectedSelectId: "selected-authors",
            filterInputId: "author-filter",
            addButtonId: "add-author",
            removeButtonId: "remove-author",
            moveUpButtonId: "move-author-up",
            moveDownButtonId: "move-author-down",
        });

        setupDualList({
            hiddenSelectId: "id_tags",
            availableSelectId: "available-tags",
            selectedSelectId: "selected-tags",
            filterInputId: "tag-filter",
            addButtonId: "add-tag",
            removeButtonId: "remove-tag",
        });

        setupDualList({
            hiddenSelectId: "id_projects",
            availableSelectId: "available-projects",
            selectedSelectId: "selected-projects",
            filterInputId: "project-filter",
            addButtonId: "add-project",
            removeButtonId: "remove-project",
        });
    })();
</script>

{% endblock %}
