{% extends "base.html" %}
{% block content %}

<h1>{% if is_edit %}Publikation bearbeiten{% else %}Publikation hinzuf체gen{% endif %}</h1>

<form method="POST" enctype="multipart/form-data" class="mt-3">
    {% csrf_token %}

    <div class="mb-3">
        {{ form.title.label_tag }}
        {{ form.title }}
        {% for error in form.title.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        {{ form.year.label_tag }}
        {{ form.year }}
        {% for error in form.year.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        {{ form.doi.label_tag }}
        {{ form.doi }}
        {% for error in form.doi.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    {{ author_choices|json_script:"author-choices" }}
    {{ selected_authors|json_script:"selected-authors" }}
    <div class="mb-3" x-data="authorPicker()" x-init="init()">
        <label class="form-label">{{ form.authors.label }}</label>
        <div class="d-none" aria-hidden="true">
            {{ form.authors.as_widget(attrs={"x-ref": "authorSelect", "class": "d-none"}) }}
        </div>

        <div class="d-flex flex-wrap gap-2 mb-2">
            <template x-for="author in selectedAuthors" :key="author.id">
                <span class="badge bg-primary d-flex align-items-center gap-2 py-2 px-3">
                    <span x-text="authorLabel(author)"></span>
                    <button type="button" class="btn-close btn-close-white btn-sm" aria-label="Autor entfernen" @click="remove(author.id)"></button>
                </span>
            </template>
            <span x-show="selectedAuthors.length === 0" class="text-muted">Keine Autoren ausgew채hlt</span>
        </div>

        <div class="input-group mb-2">
            <input type="text" class="form-control" placeholder="Autor suchen" x-model="query" aria-label="Autor suchen">
            <button class="btn btn-outline-secondary" type="button" @click="resetSearch()">Zur체cksetzen</button>
        </div>

        <div class="border rounded" x-show="filteredAuthors.length" x-cloak>
            <ul class="list-group list-group-flush">
                <template x-for="author in filteredAuthors" :key="author.id">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span x-text="authorLabel(author)"></span>
                        <button type="button" class="btn btn-sm" :class="isSelected(author.id) ? 'btn-outline-secondary' : 'btn-primary'" @click="toggle(author.id)">
                            <span x-text="isSelected(author.id) ? 'Entfernen' : 'Hinzuf체gen'"></span>
                        </button>
                    </li>
                </template>
            </ul>
        </div>

        {% for error in form.authors.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        {{ form.journal.label_tag }}
        {{ form.journal }}
        {% for error in form.journal.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        {{ form.tags.label_tag }}
        {{ form.tags }}
        {% for error in form.tags.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        {{ form.abstract.label_tag }}
        {{ form.abstract }}
        {% for error in form.abstract.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <div class="mb-3">
        {{ form.pdf.label_tag }}
        {{ form.pdf }}
        {% for error in form.pdf.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>

    <button class="btn btn-primary" type="submit">{% if is_edit %}Aktualisieren{% else %}Speichern{% endif %}</button>
    {% if is_edit %}
        <a class="btn btn-secondary" href="{% url 'publication_detail' publication.id %}">Abbrechen</a>
    {% else %}
        <a class="btn btn-secondary" href="{% url 'publication_list' %}">Abbrechen</a>
    {% endif %}
</form>

<script>
    document.addEventListener("alpine:init", () => {
        Alpine.data("authorPicker", () => ({
            allAuthors: JSON.parse(document.getElementById("author-choices").textContent || "[]"),
            selectedIds: JSON.parse(document.getElementById("selected-authors").textContent || "[]"),
            query: "",
            init() {
                this.syncSelect();
            },
            get selectedAuthors() {
                return this.allAuthors.filter((author) => this.selectedIds.includes(author.id));
            },
            get filteredAuthors() {
                const term = this.query.trim().toLowerCase();
                return this.allAuthors
                    .filter((author) => {
                        const label = this.authorLabel(author).toLowerCase();
                        return !term || label.includes(term);
                    })
                    .sort((a, b) => this.authorLabel(a).localeCompare(this.authorLabel(b), "de"));
            },
            authorLabel(author) {
                return `${author.last_name}, ${author.first_name}`.trim();
            },
            isSelected(id) {
                return this.selectedIds.includes(id);
            },
            toggle(id) {
                if (this.isSelected(id)) {
                    this.selectedIds = this.selectedIds.filter((value) => value !== id);
                } else {
                    this.selectedIds = [...this.selectedIds, id];
                }
                this.syncSelect();
            },
            remove(id) {
                this.selectedIds = this.selectedIds.filter((value) => value !== id);
                this.syncSelect();
            },
            resetSearch() {
                this.query = "";
            },
            syncSelect() {
                const select = this.$refs.authorSelect;
                if (!select) return;
                Array.from(select.options).forEach((option) => {
                    const value = parseInt(option.value, 10);
                    option.selected = this.selectedIds.includes(value);
                });
            },
        }));
    });
</script>

{% endblock %}
